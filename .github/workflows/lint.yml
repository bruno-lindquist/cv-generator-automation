name: Lint & Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint
      
      - name: Check Python imports
        run: |
          echo "üîç Verificando imports Python..."
          python -c "import cv_generator; print('‚úÖ M√≥dulo import√°vel')" || exit 1
      
      - name: Lint with flake8
        run: |
          echo "üîç Executando flake8..."
          # Para configura√ß√£o suave, ignoramos algumas verifica√ß√µes
          flake8 cv_generator.py --count --select=E9,F63,F7,F82 --show-source --statistics || true
          echo "‚úÖ Flake8 conclu√≠do"
        continue-on-error: true
      
      - name: Check file encoding
        run: |
          echo "üîç Verificando encoding de arquivos..."
          file cv_generator.py | grep -q "UTF-8" && echo "‚úÖ UTF-8 v√°lido" || echo "‚ö†Ô∏è  Encoding diferente"
      
      - name: Validate configuration files
        run: |
          echo "üîç Validando configura√ß√µes..."
          
          # Verificar se config.json tem as chaves obrigat√≥rias
          python << EOF
          import json
          
          configs = ['config.json', 'cv_data.json', 'styles.json', 'translations.json']
          for config_file in configs:
              try:
                  with open(config_file, 'r', encoding='utf-8') as f:
                      data = json.load(f)
                  print(f"‚úÖ {config_file} - OK ({len(str(data))} bytes)")
              except Exception as e:
                  print(f"‚ùå {config_file} - ERRO: {e}")
                  exit(1)
          EOF
      
      - name: Check for common issues
        run: |
          echo "üîç Verificando problemas comuns..."
          
          # Verificar se n√£o tem TODO n√£o resolvido
          if grep -r "TODO.*URGENT" cv_generator.py; then
            echo "‚ö†Ô∏è  Encontrado TODO urgente"
          fi
          
          # Verificar se n√£o tem print() em produ√ß√£o
          if grep -n "print(" cv_generator.py | grep -v "logger" | grep -v "#"; then
            echo "‚ö†Ô∏è  Encontrado print() sem logger"
          fi
          
          echo "‚úÖ Verifica√ß√£o conclu√≠da"
        continue-on-error: true
      
      - name: Summary
        run: |
          echo "‚úÖ Verifica√ß√µes de qualidade conclu√≠das!"
          echo ""
          echo "Valida√ß√µes realizadas:"
          echo "  ‚úì Python imports"
          echo "  ‚úì Flake8 linting"
          echo "  ‚úì Encoding UTF-8"
          echo "  ‚úì JSON v√°lido"
          echo "  ‚úì Problemas comuns"
