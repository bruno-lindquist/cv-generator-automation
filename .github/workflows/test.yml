name: Test CV Generator

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Display Python version
        run: python -c "import sys; print(sys.version)"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Validate Python syntax
        run: |
          echo "üîç Validando sintaxe Python..."
          python -m py_compile cv_generator.py
          echo "‚úÖ Sintaxe Python v√°lida"
      
      - name: Validate JSON files
        run: |
          echo "üîç Validando arquivos JSON..."
          python -m json.tool cv_data.json > /dev/null && echo "‚úÖ cv_data.json v√°lido"
          python -m json.tool styles.json > /dev/null && echo "‚úÖ styles.json v√°lido"
          python -m json.tool translations.json > /dev/null && echo "‚úÖ translations.json v√°lido"
          python -m json.tool config.json > /dev/null && echo "‚úÖ config.json v√°lido"
      
      - name: Generate test CV (Portuguese)
        run: |
          echo "üáßüá∑ Gerando CV em portugu√™s..."
          python cv_generator.py -l pt -o output/test_pt.pdf
          ls -lh output/test_pt.pdf
          echo "‚úÖ CV em portugu√™s gerado com sucesso"
      
      - name: Generate test CV (English)
        run: |
          echo "üá¨üáß Gerando CV em ingl√™s..."
          python cv_generator.py -l en -o output/test_en.pdf
          ls -lh output/test_en.pdf
          echo "‚úÖ CV em ingl√™s gerado com sucesso"
      
      - name: Verify PDF files exist
        run: |
          echo "üîç Verificando PDFs gerados..."
          [ -f output/test_pt.pdf ] && echo "‚úÖ PDF PT existe" || (echo "‚ùå PDF PT n√£o encontrado" && exit 1)
          [ -f output/test_en.pdf ] && echo "‚úÖ PDF EN existe" || (echo "‚ùå PDF EN n√£o encontrado" && exit 1)
      
      - name: Check PDF file sizes
        run: |
          echo "üìä Tamanho dos PDFs:"
          PT_SIZE=$(stat -c%s "output/test_pt.pdf" 2>/dev/null || stat -f%z "output/test_pt.pdf")
          EN_SIZE=$(stat -c%s "output/test_en.pdf" 2>/dev/null || stat -f%z "output/test_en.pdf")
          echo "  PT: $((PT_SIZE / 1024)) KB"
          echo "  EN: $((EN_SIZE / 1024)) KB"
          
          # Verificar se os PDFs n√£o est√£o vazios
          if [ $PT_SIZE -lt 1000 ]; then
            echo "‚ùå PDF PT muito pequeno"
            exit 1
          fi
          if [ $EN_SIZE -lt 1000 ]; then
            echo "‚ùå PDF EN muito pequeno"
            exit 1
          fi
          echo "‚úÖ Tamanhos OK"
      
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-pdfs-py${{ matrix.python-version }}
          path: output/test_*.pdf
          retention-days: 5
      
      - name: Summary
        if: success()
        run: |
          echo "üéâ Todos os testes passaram!"
          echo ""
          echo "‚úÖ Valida√ß√µes conclu√≠das:"
          echo "  ‚úì Sintaxe Python"
          echo "  ‚úì JSON v√°lido (cv_data, styles, translations, config)"
          echo "  ‚úì CV em Portugu√™s gerado"
          echo "  ‚úì CV em Ingl√™s gerado"
          echo "  ‚úì PDFs com tamanho apropriado"
